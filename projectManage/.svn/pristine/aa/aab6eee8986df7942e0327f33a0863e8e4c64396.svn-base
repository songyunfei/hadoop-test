package com.linkGap.projectManage.controller;

import java.io.File;
import java.net.URLDecoder;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import com.linkGap.projectManage.model.ReturnResultUtil;
import com.linkGap.projectManage.model.entity.ProjectContacts;
import com.linkGap.projectManage.model.entity.ProjectInfo;
import com.linkGap.projectManage.model.view.ProjectRequestParams;
import com.linkGap.projectManage.service.ProjectService;
import com.linkGap.projectManage.utils.ImageCompressionUtils;


@RestController
@RequestMapping(value="/project")
public class ProjectController {
    
	@Autowired
	private ProjectService projectService;
	
	//@Value("${upload.image.path}")
	private String picPath="F:\\";
	
	/**
	 * 工程列表查询
	 * @author  songyunfei
	 * 2018年1月12日
	 */
	@RequestMapping(value="/list",method=RequestMethod.GET)
	public ReturnResultUtil projectList(ProjectRequestParams params){
		try {
			ReturnResultUtil result=projectService.queryList(params);
			return result;
		} catch (Exception e) {
			e.printStackTrace();
			return new ReturnResultUtil("01","后台异常");
		}
	}
	/**
	 * 添加工程
	 * @author  songyunfei
	 * 2018年1月15日
	 */
	@RequestMapping(value="/add",method=RequestMethod.POST)
	
	public ReturnResultUtil addProject(ProjectInfo projectInfo,
			                           @RequestParam(value="constructionfiles") MultipartFile[] constructionfiles,
			                           @RequestParam(value="contractImagefiles")MultipartFile[] contractImagefiles,
			                           HttpServletRequest request){
		try {
			String name=request.getParameter("buildingName");
			String buildname=URLDecoder.decode(projectInfo.getBuildingName());
			//施工图纸
			String constructionImageUrls ="";
			//施工图纸缩略图
			String constructionShortImageUrls ="";
			if(constructionfiles!=null&&constructionfiles.length>0){
				for (MultipartFile multipartFile : constructionfiles) {
				     String fileName=multipartFile.getOriginalFilename();
				     fileName=System.currentTimeMillis()+fileName;
				     String path=picPath+File.separator+fileName;
				     String zippath=picPath+File.separator+"zip_"+fileName;
				     multipartFile.transferTo(new File(path));
				     ImageCompressionUtils.zipWidthHeightImageFile(path,zippath,100,100,1f);
				     constructionImageUrls+=path+",";
				     constructionShortImageUrls+=zippath+",";		 
				}
			}
			String contractImageUrls ="";
			String contractShortImageUrls ="";
			if(contractImagefiles!=null&&contractImagefiles.length>0){
			for (MultipartFile multipartFile : contractImagefiles) {
			     String fileName=multipartFile.getOriginalFilename();
			     fileName=System.currentTimeMillis()+fileName;
			     String path=picPath+File.separator+fileName;
			     String zippath=picPath+File.separator+"zip_"+fileName;
			     multipartFile.transferTo(new File(path));
			     ImageCompressionUtils.zipWidthHeightImageFile(path,zippath,100,100,1f);
			     contractImageUrls+=path+",";
			     contractShortImageUrls+=zippath+",";		 
			}
			}
			projectInfo.setConstructionImageUrls(constructionImageUrls);
			projectInfo.setConstructionShortImageUrls(constructionShortImageUrls);
			projectInfo.setContractImageUrls(contractImageUrls);
			projectInfo.setContractShortImageUrls(contractShortImageUrls);
			this.projectService.saveProject(projectInfo);
		} catch (Exception e) {
			e.printStackTrace();
			return new ReturnResultUtil("01","保存失败，请稍后再试!");
		}
		return new ReturnResultUtil();
	}
	
	
	
}
