package com.linkGap.projectManage.controller;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import com.linkGap.projectManage.anotation.OperationLogAnotation;
import com.linkGap.projectManage.model.ReturnResultUtil;
import com.linkGap.projectManage.model.entity.SysUser;
import com.linkGap.projectManage.model.view.ChangePasswdView;
import com.linkGap.projectManage.service.SysUserService;
import com.linkGap.projectManage.utils.MD5Util;

@Controller
@RequestMapping("/user")
public class SysUserController {
	
	private Logger logger = Logger.getLogger(SysUserController.class);
	
	
	@Autowired
	private SysUserService sysUserService;
	
	

	/**
	 * @author lichen
	 * 修改密码   成功后并返回对应用户信息
	 * @param username
	 * @param password
	 * @return
	 */
	@OperationLogAnotation(moduleName="修改密码",operation="修改密码并返回用户的一些基本信息")
	@RequestMapping(value="/changePassword",method=RequestMethod.POST)
	@ResponseBody
	public ReturnResultUtil changePassword(@RequestParam(value="username")String username,@RequestParam(value="password")String password){
		ReturnResultUtil returnResultUtil=new ReturnResultUtil();
		try{
			SysUser user = new SysUser();
			user.setUsername(username);
			user.setPassword(MD5Util.encode(password, 2));
			int updatePasswdFlag = sysUserService.updatePasswdByUserName(user);
			if(updatePasswdFlag>0){//表示更新密码成功
				returnResultUtil.setResultCode("00");
				returnResultUtil.setResultMsg("登录成功！");
				ChangePasswdView userInfoByUserObj = sysUserService.getUserInfoByUserName(username);
				returnResultUtil.setResultValue(userInfoByUserObj);
			}else{//表示更新密码失败
				returnResultUtil.setResultCode("01");
				returnResultUtil.setResultMsg("用户已经被锁定不能登录，请与管理员联系！");
			}
		}catch(Exception e){
			returnResultUtil.setResultCode("01");
			returnResultUtil.setResultMsg("用户已经被锁定不能登录，请与管理员联系！");
			logger.error("修改密码失败！", e);
		}
		return returnResultUtil;
	}
	
	
}
